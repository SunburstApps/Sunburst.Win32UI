<Project>
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <UpdateEntryPointResources Condition="'$(UpdateEntryPointResources)' == '' and '$(GuiEntryPoint)' == 'true'">true</UpdateEntryPointResources>
    <SetEntryPointVersionFromAssemblyMetadata Condition="'$(SetEntryPointVersionFromAssemblyMetadata)' == '' and '$(UpdateEntryPointResources)' == 'true'">true</SetEntryPointVersionFromAssemblyMetadata>
    <UacPrivilegeLevel Condition="'$(UacPrivilegeLevel)' == ''">AsInvoker</UacPrivilegeLevel>
  </PropertyGroup>

  <UsingTask TaskName="GenerateResourceScript" AssemblyFile="$(Win32UIBuildTasksAssembly)" />
  <UsingTask TaskName="CompileResourceScript" AssemblyFile="$(Win32UIBuildTasksAssembly)" />
  <UsingTask TaskName="LinkResourceDll" AssemblyFile="$(Win32UIBuildTasksAssembly)" />
  <UsingTask TaskName="MsvcSxsManifestTool" AssemblyFile="$(Win32UIBuildTasksAssembly)" />
  <UsingTask TaskName="CopyResourceSegment" AssemblyFile="$(Win32UIBuildTasksAssembly)" />
  <UsingTask TaskName="SetNativeVersionInfo" AssemblyFile="$(Win32UIBuildTasksAssembly)" />

  <!-- The MSBuildProjectFullPath is here to ensure that the target always runs, even if no icons or RC fragments were specified. -->
  <Target Name="GenerateEntryPointResourceScript" DependsOnTargets="PrepareForBuild;LocateWindowsSDK"
          Inputs="@(EntryPointIcon);@(EntryPointRCFragment);$(MSBuildProjectFullPath)" Outputs="$(IntermediateOutputPath)/EntryPoint.rc">
    <GenerateResourceScript Icons="@(EntryPointIcon)" ScriptFragments="@(EntryPointRCFragment)"
                            OutputFile="$(IntermediateOutputPath)/EntryPoint.rc" />

    <ItemGroup>
      <ResourceScript Include="$(IntermediateOutputPath)/EntryPoint.rc" />
      <FileWrites Include="$(IntermediateOutputPath)/EntryPoint.rc" />
    </ItemGroup>
  </Target>

  <Target Name="CompileEntryPointResources" DependsOnTargets="PrepareForBuild;LocateWindowsSDK;GenerateEntryPointResourceScript"
          Inputs="@(ResourceScript)" Outputs="$(IntermediateOutputPath)/EntryPoint.res">
    <CompileResourceScript ResourceScripts="@(ResourceScript)" OutputFile="$(IntermediateOutputPath)/EntryPoint.res"
                           WindowsSDKBinDirectory="$(WindowsSDKBinDirectory)" IncludePaths="@(_NativeIncludeDirectory)" />

    <ItemGroup>
      <FileWrites Include="$(IntermediateOutputPath)/EntryPoint.res" />
    </ItemGroup>
  </Target>

  <Target Name="LinkEntryPointResources" DependsOnTargets="PrepareForBuild;LocateWindowsSDK;CompileEntryPointResources"
          Inputs="$(IntermediateOutputPath)/EntryPoint.res;@(SxsManifestFragment)"
          Outputs="$(IntermediateOutputPath)/EntryPointResources.dll">
    <LinkResourceDll OutputFilePath="$(IntermediateOutputPath)/EntryPointResources.dll"
                     Objects="$(IntermediateOutputPath)/EntryPoint.res"
                     UacPrivilegeLevel="$(UacPrivilegeLevel)"
                     LibraryPaths="@(_NativeLibraryDirectory)"
                     WindowsSDKBinDirectory="$(WindowsSDKBinDirectory)" />

    <MsvcSxsManifestTool InputAssembly="$(IntermediateOutputPath)/EntryPointResources.dll"
                         OutputManifestFile="$(IntermediateOutputPath)/EntryPoint.manifest"
                         WindowsSDKBinDirectory="$(WindowsSDKBinDirectory)" />
    <MsvcSxsManifestTool InputManifestFile="$(IntermediateOutputPath)/EntryPoint.manifest"
                         OutputAssembly="$(OutputPath)$(TargetName).exe"
                         ManifestFragments="@(SxsManifestFragment)"
                         CanonicalizeXml="true" WindowsSDKBinDirectory="$(WindowsSDKBinDirectory)" />

    <ItemGroup>
      <FileWrites Include="$(IntermediateOutputPath)/EntryPointResources.dll" />
      <FileWrites Include="$(IntermediateOutputPath)/EntryPoint.manifest" />
    </ItemGroup>
  </Target>

  <Target Name="CoreCopyEntryPointResources" DependsOnTargets="LinkEntryPointResources">
    <CopyResourceSegment InputFile="$(IntermediateOutputPath)/EntryPointResources.dll"
                         OutputFile="$(OutputPath)$(TargetName).exe" />

    <SetNativeVersionInfo Condition="'$(SetEntryPointVersionFromAssemblyMetadata)' == 'true'" InputFiles="$(OutputPath)$(TargetName).exe"
                          FileVersion="$(FileVersion)" ProductVersion="$(Version)" CompanyName="$(Authors)" FileDescription="$(AssemblyTitle)"
                          LegalCopyright="$(Copyright)" ProductName="$(Product)" />
  </Target>

  <Target Name="CopyEntryPointResourcesForCoreRT" DependsOnTargets="CoreCopyEntryPointResources" AfterTargets="LinkNative"
          Condition="'$(IlcCalledViaPackage)' == 'true' and '$(NativeBinaryExt)' == '.exe'" />
  <Target Name="CopyEntryPointResources" DependsOnTargets="CoreCopyEntryPointResources" AfterTargets="Build"
          Condition="'$(IlcCalledViaPackage)' == '' and '$(DeployAppHost)' == 'true'" />
</Project>
